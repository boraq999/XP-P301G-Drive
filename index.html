<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªÙÙˆÙ‚ÙˆÙ†</title>
    <script src="https://cdn.jsdelivr.net/npm/qz-tray/qz-tray.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap');

        :root {
            --primary: #2563eb;
            --success: #059669;
            --bg: #f8fafc;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        /*Sidebar*/
        .sidebar {
            width: 280px;
            background: #1e293b;
            color: white;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        /*Main Content*/
        .main {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }

        /*Invoice Preview Styling*/
        #invoice-to-print {
            width: 72mm;
            background: white;
            margin: 0 auto;
            padding: 5mm;
            color: black;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            font-family: 'Arial', sans-serif;
            /* Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© ÙŠÙØ¶Ù„ Ø®Ø·ÙˆØ· Ø¨Ø³ÙŠØ·Ø© */
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-online {
            background: #dcfce7;
            color: #166534;
        }

        .status-offline {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Invoice Elements (Same as our template but for preview) */
        .inv-header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 3mm;
            margin-bottom: 3mm;
        }

        .inv-table {
            width: 100%;
            border-collapse: collapse;
        }

        .inv-table th {
            text-align: right;
            border-bottom: 1px solid #000;
            padding: 1mm 0;
            font-size: 9pt;
        }

        .inv-table td {
            padding: 1.5mm 0;
            font-size: 8.5pt;
        }

        .inv-total {
            border-top: 2px solid #000;
            margin-top: 2mm;
            padding-top: 2mm;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2 style="color: #38bdf8;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
        <div style="margin-top: auto;">
            <div id="printer-status" class="status-badge status-offline">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ QZ...</div>
        </div>
    </div>

    <div class="main">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin:0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h1>
            <button class="btn btn-primary" onclick="generateAndPrint()">
                <span>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¢Ù†</span>
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Left: Settings -->
            <div class="card">
                <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
                        <input type="text" value="#INV-2026/001"
                            style="width:100%; padding:0.5rem; margin-top:0.25rem;">
                    </div>
                    <div>
                        <label>Ø§Ù„Ù…Ø³ÙˆÙ‚:</label>
                        <input type="text" value="ØµÙ…Ø§Ù… Ø§Ù„Ø¹Ø§Ù„Ù…" style="width:100%; padding:0.5rem; margin-top:0.25rem;">
                    </div>
                    <p style="color: #64748b; font-size: 0.875rem;">
                        * Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© ÙƒÙ†Ø¸Ø§Ù… RAW Ù„Ø¶Ù…Ø§Ù† Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø©.
                    </p>
                </div>
            </div>

            <!-- Right: Preview -->
            <div class="card"
                style="display: flex; align-items: flex-start; justify-content: center; background: #e2e8f0;">
                <div id="invoice-to-print">
                    <div class="inv-header">
                        <strong style="font-size: 14pt;">Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙÙˆÙ‚ÙˆÙ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</strong><br>
                        <span>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø©</span>
                    </div>

                    <div style="font-size: 8.5pt; margin-bottom: 3mm;">
                        <span>Ø±Ù‚Ù…: #INV-2026/0042</span><br>
                        <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: 2026-02-27</span><br>
                        <span>Ø§Ù„Ù…ØªØ¬Ø±: ØªØ§Ø¬ Ù…ÙˆÙ„ - Ø·Ø±Ø§Ø¨Ù„Ø³</span>
                    </div>

                    <table class="inv-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th style="text-align:center">ÙƒÙ…ÙŠØ©</th>
                                <th style="text-align:left">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Ø£ÙƒÙˆØ§Ø¨ Ø¨Ù„Ø§Ø³ØªÙŠÙƒ Ø£Ø¨ÙŠØ¶</td>
                                <td style="text-align:center">10</td>
                                <td style="text-align:left">110.0</td>
                            </tr>
                            <tr>
                                <td>Ø£ÙƒÙˆØ§Ø¨ Ø¨Ù„Ø§Ø³ØªÙŠÙƒ Ø£Ø²Ø±Ù‚</td>
                                <td style="text-align:center">5</td>
                                <td style="text-align:left">135.0</td>
                            </tr>
                            <tr>
                                <td>Ø­Ø§ÙØ¸Ø© Ø·Ø¹Ø§Ù… 60*110</td>
                                <td style="text-align:center">2</td>
                                <td style="text-align:left">100.0</td>
                            </tr>
                            <tr>
                                <td>Ø£ÙƒÙˆØ§Ø¨ Ù†Ø³ÙƒØ§ÙÙŠÙ‡ ÙˆØ±Ù‚</td>
                                <td style="text-align:center">20</td>
                                <td style="text-align:left">400.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 1</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">10.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 2</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">15.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 3</td>
                                <td style="text-align:center">3</td>
                                <td style="text-align:left">30.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 4</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">12.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 5</td>
                                <td style="text-align:center">2</td>
                                <td style="text-align:left">24.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 6</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">50.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 7</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">45.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 8</td>
                                <td style="text-align:center">10</td>
                                <td style="text-align:left">100.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 9</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">20.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 10</td>
                                <td style="text-align:center">2</td>
                                <td style="text-align:left">40.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 11</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">15.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 12</td>
                                <td style="text-align:center">3</td>
                                <td style="text-align:left">45.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 13</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">10.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 14</td>
                                <td style="text-align:center">5</td>
                                <td style="text-align:left">25.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 15</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">100.0</td>
                            </tr>
                            <tr>
                                <td>Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… 16</td>
                                <td style="text-align:center">1</td>
                                <td style="text-align:left">15.0</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="inv-total">
                        <div style="display:flex; justify-content:space-between;">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                            <span>745.00 Ø¯.Ù„</span>
                        </div>
                    </div>

                    <div
                        style="text-align:center; margin-top: 5mm; font-size: 8pt; border-top: 1px dashed #000; padding-top: 2mm;">
                        Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§<br>
                        www.almotafaweqon.ly
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PRINTER_NAME = "XP-P301G";

        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù€ QZ Tray
        window.onload = async () => {
            const status = document.getElementById('printer-status');
            try {
                await qz.websocket.connect();
                status.innerText = "âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©";
                status.className = "status-badge status-online";
                qz.security.setCertificatePromise((res) => res());
            } catch (e) {
                status.innerText = "âŒ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© ØºÙŠØ± Ù…ØªØµÙ„Ø© (Ø§ÙØªØ­ QZ Tray)";
                status.className = "status-badge status-offline";
            }
        };

        async function generateAndPrint() {
            const status = document.getElementById('printer-status');
            const invoiceElement = document.getElementById('invoice-to-print');

            try {
                status.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";

                // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ HTML Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­
                const canvas = await html2canvas(invoiceElement, {
                    scale: 3, // Ù„Ø¶Ù…Ø§Ù† Ø­Ø¯Ø© Ø§Ù„Ù†Øµ
                    useCORS: true
                });

                // 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
                const base64Image = canvas.toDataURL("image/png").split(',')[1];

                // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© (ÙˆØ¶Ø¹ Continuous)
                const config = qz.configs.create(PRINTER_NAME);

                // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ£ÙˆØ§Ù…Ø± RAW ESC/POS (Ø§Ù„Ø­Ù„ Ø§Ù„Ù„ÙŠ Ù†Ø¬Ø­ Ù…Ø¹Ø§Ù†Ø§)
                const data = [{
                    type: 'raw',
                    format: 'image',
                    flavor: 'base64',
                    data: base64Image,
                    options: {
                        language: "ESCPOS",
                        dotDensity: "double"
                    }
                }];

                await qz.print(config, data);
                status.innerText = "âœ… ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!";

                setTimeout(() => {
                    status.innerText = "âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©";
                    status.className = "status-badge status-online";
                }, 3000);

            } catch (e) {
                console.error(e);
                alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: " + e.message);
                status.innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£";
            }
        }
    </script>
</body>

</html>